# View Implementation Plan: Create

## 1. Overview
This document outlines the implementation plan for the "Create" view. This view provides the primary interface for users to generate new flashcards. It consists of a large text area where users can paste content, a real-time word count validator, and a "Generate" button. The view handles the client-side validation for text length and manages the API call to the AI service, including displaying a loading state during generation and redirecting to the review page on success.

## 2. View Routing
- **Path**: `/create`
- **Accessibility**: This route is protected and must only be accessible to authenticated users.

## 3. Component Structure
The view will be a single React component acting as an Astro island, containing all necessary state and logic.

```
/create (Layout.astro)
  └── CreateView.tsx (Client-side React Component)
      ├── h1 ("Create Flashcards")
      ├── p ("Paste your text below...")
      ├── form
      │   ├── textarea (for user input)
      │   ├── WordCountValidator.tsx (displays word count and validation status)
      │   └── button (type="submit", text="Generate")
      └── GenerationLoadingOverlay.tsx (modal overlay shown during API call)
```

## 4. Component Details

### `CreateView.tsx`
- **Component Description**: The main root component for the view. It manages the state of the text input, word count, validation, and the submission process to the generation endpoint.
- **Main Elements**: A `form` element containing a `textarea` and a submit `button`. It will also conditionally render the `GenerationLoadingOverlay`.
- **Handled Interactions**:
    - `onChange` on the `textarea` to update the text state and re-calculate the word count.
    - `onSubmit` on the `form` to trigger the generation process.
- **Handled Validation**:
    - Real-time validation of the word count of the text in the `textarea`. The "Generate" button will be disabled if the word count is not between 1,000 and 10,000 words.
- **Types**: `CreateViewModel`, `GeneratedFlashcardDto`.
- **Props**: None.

### `WordCountValidator.tsx`
- **Component Description**: A small presentational component that displays the live word count and provides visual feedback (e.g., color change) based on whether the count is within the valid range.
- **Main Elements**: A `p` tag to display the count.
- **Handled Interactions**: None.
- **Handled Validation**: Visually indicates if the `wordCount` is valid.
- **Types**: None.
- **Props**:
    - `wordCount: number`
    - `min: number`
    - `max: number`

### `GenerationLoadingOverlay.tsx`
- **Component Description**: A modal overlay that covers the view while the AI is generating flashcards. It provides crucial user feedback that the system is working.
- **Main Elements**: A container `div` with a semi-transparent background, a loading spinner, and a status `p` tag with `aria-live="polite"` for accessibility.
- **Handled Interactions**: None.
- **Handled Validation**: None.
- **Types**: None.
- **Props**:
    - `isOpen: boolean`

## 5. Types

### DTOs (Data Transfer Objects)
```typescript
// DTO for a flashcard generated by the AI, from POST /api/flashcards/generate
type GeneratedFlashcardDto = {
  question: string;
  answer: string;
};
```

### ViewModels (Client-side State)
```typescript
// Represents the complete state for the CreateView
interface CreateViewModel {
  text: string;
  isLoading: boolean;
  error: string | null;
}
```
- **`text`**: Stores the raw string from the `textarea`.
- **`isLoading`**: `true` when the API request to `/api/flashcards/generate` is in flight. Controls the `GenerationLoadingOverlay`.
- **`error`**: Stores any error message from the API call to be displayed to the user.

## 6. State Management
State will be managed locally within the `CreateView` component using React's `useState` hook. Derived state like `wordCount` and `isValid` will be calculated on-the-fly during render to ensure consistency.

- **State Variables**:
    - `const [text, setText] = useState('');`
    - `const [isLoading, setIsLoading] = useState(false);`
    - `const [error, setError] = useState<string | null>(null);`
- **Derived State**:
    - `const wordCount = text.trim().split(/\s+/).length;`
    - `const isValid = wordCount >= 1000 && wordCount <= 10000;`

## 7. API Integration
- **Generation**:
    - **Endpoint**: `POST /api/flashcards/generate`
    - **Action**: Triggered by the form's `onSubmit` event.
    - **Request**: A `fetch` call with a JSON body: `{ "text": "..." }`.
    - **Response**: On success, the response will be `{ data: GeneratedFlashcardDto[] }`. The `data` array must be passed to the `/review` page. This will be done by storing the array in `sessionStorage` before redirecting.
    - **Redirect**: After successfully fetching and storing the data, perform a client-side redirect to `/review`.

## 8. User Interactions
1.  **Typing**: The user types or pastes text into the `textarea`. The word count updates in real-time. The "Generate" button enables or disables based on the word count.
2.  **Submission**: The user clicks the "Generate" button. The `GenerationLoadingOverlay` appears, and the API call is made.
3.  **Success**: The API returns a list of generated flashcards. The app stores this list in `sessionStorage` and redirects the user to `/review`.
4.  **Failure**: The API returns an error. The loading overlay disappears, and an error message is displayed near the form.

## 9. Conditions and Validation
- **Word Count Validation**:
    - **Condition**: The number of words in the `textarea` must be between 1,000 and 10,000.
    - **Component**: `CreateView`.
    - **Action**: The `disabled` attribute of the "Generate" button is toggled based on this condition. The `WordCountValidator` component will also change its appearance (e.g., text color) to reflect the validity.

## 10. Error Handling
- **API Error (400 Bad Request)**: If the API rejects the text for length issues, display the error message from the API response.
- **API Error (500 Internal Server Error)**: If the AI service fails, display a generic error message like "Failed to generate flashcards. Please try again later."
- **Network Error**: If the `fetch` call fails due to network issues, display a generic message like "A network error occurred. Please check your connection and try again."
- In all error cases, `isLoading` must be set to `false` to hide the loading overlay.

## 11. Implementation Steps
1.  **Create Files**: Create `src/pages/create.astro` and the React components under `src/components/views/create/`: `CreateView.tsx`, `WordCountValidator.tsx`, and `GenerationLoadingOverlay.tsx`.
2.  **Build `CreateView`**:
    - Implement the `textarea` and state management for the text.
    - Calculate derived state for word count and validity.
    - Implement the `handleSubmit` function to call the API.
3.  **API Logic**: Inside `handleSubmit`, perform the `fetch` call to `POST /api/flashcards/generate`. Handle the `isLoading` state.
4.  **Data Passing & Redirect**: On a successful API response, use `sessionStorage.setItem('generatedFlashcards', JSON.stringify(data))` and then `window.location.href = '/review'`.
5.  **Build UI Components**: Implement the `WordCountValidator` and `GenerationLoadingOverlay` components with appropriate props and styling using Tailwind CSS.
6.  **Integrate in Astro**: In `create.astro`, import and render the `CreateView` component as a client-side island (`client:load`).
7.  **Test**: Manually test the entire flow: text input, validation, button disabling/enabling, successful submission and redirect, and API error handling.
