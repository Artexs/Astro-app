# View Implementation Plan: Review

## 1. Overview
This document details the implementation for the "Review" view. This page is displayed after a user successfully generates a set of flashcards. It presents the AI-generated cards in a grid, allowing the user to individually "Accept" or "Reject" each one. Accepted cards are saved to the user's collection, while rejected cards are discarded. Once all cards have been processed, a completion summary is shown.

## 2. View Routing
- **Path**: `/review`
- **Accessibility**: This route is protected. It's intended to be accessed immediately after a successful generation, so it relies on data being passed from the `/create` view.

## 3. Component Structure
The view is a React island that dynamically displays either the review grid or the completion screen.

```
/review (Layout.astro)
  └── ReviewView.tsx (Client-side React Component)
      ├── (Conditional: cardsToReview.length > 0)
      │   ├── h1 ("Review Generated Cards")
      │   └── GridContainer (div)
      │       └── ReviewableCard.tsx (mapped from array)
      └── (Conditional: cardsToReview.length === 0)
          └── ReviewCompletion.tsx
```

## 4. Component Details

### `ReviewView.tsx`
- **Component Description**: The main component that manages the list of cards needing review. It handles loading the initial data from `sessionStorage`, processing accept/reject actions, and displaying the final completion screen.
- **Main Elements**: Conditionally renders the grid of `ReviewableCard` components or the `ReviewCompletion` component.
- **Handled Interactions**:
    - On mount, it reads the generated cards from `sessionStorage`.
    - Handles `onAccept` and `onReject` callbacks from child `ReviewableCard` components.
- **Handled Validation**:
    - If no cards are found in `sessionStorage` on load, it will redirect the user to `/create` to prevent an empty/broken state.
- **Types**: `GeneratedFlashcardDto`, `ReviewViewModel`.
- **Props**: None.

### `ReviewableCard.tsx`
- **Component Description**: A component that displays a single generated flashcard with its question and answer, along with "Accept" and "Reject" buttons.
- **Main Elements**: A card-styled `div`, `p` tags for the question and answer, and two `button` elements.
- **Handled Interactions**:
    - `onClick` on the "Accept" button, which calls the `onAccept` prop.
    - `onClick` on the "Reject" button, which calls the `onReject` prop.
- **Handled Validation**: The "Accept" button can be disabled via the `isSaving` prop while its API call is in flight.
- **Types**: `GeneratedFlashcardDto`.
- **Props**:
    - `card: GeneratedFlashcardDto`
    - `onAccept: (card: GeneratedFlashcardDto) => void`
    - `onReject: (card: GeneratedFlashcardDto) => void`
    - `isSaving: boolean`

### `ReviewCompletion.tsx`
- **Component Description**: A summary screen shown after the user has reviewed all generated cards.
- **Main Elements**: A container `div`, a success message (e.g., "You added X new cards to your collection!"), and navigation buttons/links to "Study" and "Create More".
- **Handled Interactions**:
    - `onClick` on navigation buttons to redirect to `/study` or `/create`.
- **Handled Validation**: None.
- **Types**: None.
- **Props**:
    - `acceptedCount: number`

## 5. Types

### DTOs (Data Transfer Objects)
```typescript
// DTO for a card generated by the AI, received from the Create page
type GeneratedFlashcardDto = {
  question: string;
  answer: string;
};

// Command model for the request payload to POST /api/flashcards
type CreateFlashcardCommand = {
  question: string;
  answer: string;
};
```

### ViewModels (Client-side State)
```typescript
// Represents the complete state for the ReviewView
interface ReviewViewModel {
  cardsToReview: GeneratedFlashcardDto[];
  acceptedCount: number;
  isSaving: { [cardIdentifier: string]: boolean }; // Tracks saving state per card
  error: string | null;
}
```
- **`cardsToReview`**: An array of cards loaded from `sessionStorage` that the user needs to review.
- **`acceptedCount`**: A counter for how many cards the user has accepted.
- **`isSaving`**: An object to track the saving state of individual cards to prevent double-clicks. The key can be a unique identifier for the card (e.g., `card.question` or an index).
- **`error`**: Stores any error messages from API calls.

## 6. State Management
A custom hook, `useReviewView`, will encapsulate the view's logic.

- **`useReviewView` Hook**:
    - **Responsibility**: Manages the `cardsToReview` list and `acceptedCount`. It will load data from `sessionStorage` on initialization and provide functions to handle accept/reject actions.
    - **Exposed API**:
        - `state: ReviewViewModel`
        - `handleAccept: (card: GeneratedFlashcardDto) => void`
        - `handleReject: (card: GeneratedFlashcardDto) => void`
    - **Internal Logic**:
        - A `useEffect` on mount will read from `sessionStorage.getItem('generatedFlashcards')`, parse the JSON, and populate the `cardsToReview` state. It will also clear the item from storage to prevent re-processing on a page refresh.
        - `handleAccept` will trigger the API call and update state on success.
        - `handleReject` will simply update the client-side state.

## 7. API Integration
- **Saving a Card**:
    - **Endpoint**: `POST /api/flashcards`
    - **Action**: Triggered when a user clicks "Accept" on a `ReviewableCard`.
    - **Request**: A `fetch` call with a `CreateFlashcardCommand` body: `{ question, answer }`.
    - **Response**: On a successful `201 Created` response, the `handleAccept` function will increment `acceptedCount` and remove the card from the `cardsToReview` list.

## 8. User Interactions
1.  **Initial Load**: The user is redirected from `/create`. The `ReviewView` mounts and loads the list of cards from `sessionStorage`.
2.  **Rejecting a Card**: The user clicks "Reject". The card is removed from the UI with a fade-out animation.
3.  **Accepting a Card**: The user clicks "Accept". The button enters a loading state. An API call is made. On success, the card is removed from the UI, and the internal `acceptedCount` is incremented.
4.  **Review Completion**: After the last card is accepted or rejected, the review grid is replaced by the `ReviewCompletion` component, showing the summary and next-step navigation.

## 9. Conditions and Validation
- **No Generated Cards**:
    - **Condition**: On page load, if `sessionStorage.getItem('generatedFlashcards')` is null or empty.
    - **Component**: `useReviewView` hook.
    - **Action**: Redirect the user to `/create`.

## 10. Error Handling
- **API Error on Accept**: If the `POST /api/flashcards` call fails, the `isSaving` state for that card should be reset. An error message should be displayed to the user (e.g., via a toast notification) indicating that the card could not be saved and that they can try again.
- **Data Loading Error**: If the data from `sessionStorage` is malformed or fails to parse, redirect to `/create` as a fallback.

## 11. Implementation Steps
1.  **Create Files**: Create `src/pages/review.astro` and the React components under `src/components/views/review/`: `ReviewView.tsx`, `ReviewableCard.tsx`, and `ReviewCompletion.tsx`.
2.  **Develop `useReviewView` Hook**: Implement the state and logic for loading data from `sessionStorage`, handling accept/reject actions, and managing the `acceptedCount`.
3.  **Build `ReviewView`**: Use the `useReviewView` hook. Implement the conditional logic to show either the card grid or the completion screen.
4.  **Build `ReviewableCard`**: Create the card component with its question, answer, and buttons. Connect the buttons to the props passed down from `ReviewView`.
5.  **Build `ReviewCompletion`**: Create the summary screen component.
6.  **API Logic**: Implement the `fetch` call for `POST /api/flashcards` within the `handleAccept` function in the hook.
7.  **Integrate in Astro**: In `review.astro`, render the `ReviewView` component as a client-side island (`client:load`).
8.  **Test**: Manually test the full review flow. Ensure cards are removed correctly, the accepted count is accurate, and the completion screen appears. Test API failure scenarios for the "Accept" action.
